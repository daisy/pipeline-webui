@(fwkJob: org.daisy.pipeline.client.models.Job, uiJob: models.Job)

@main("View job", "jobs", Array("createJob.js")) {

@if(flash.contains("error")) {
    <div role="alert" class="alert alert-error">
    	<a class="close" data-dismiss="alert">&times;</a>
        @flash.get("error")
    </div>
}

@if(flash.contains("success")) {
    <div role="alert" class="alert alert-success">
    	<a class="close" data-dismiss="alert">&times;</a>
        @flash.get("success")
    </div>
}

<hgroup>
	<h1>Job Summary<br>
	<small id="header-nicename">@uiJob.nicename</small></h1>
	
	<small><a class="accordion-toggle collapsed" data-toggle="collapse" href="#job-details">
		<style>
			#job-details-show { display:none; }
			.collapsed #job-details-show { display:inline; }
			#job-details-hide { display:inline; }
			.collapsed #job-details-hide { display:none; }
		</style>
		<span id="job-details-show"><i class="icon-chevron-down"></i>Show details</span>
		<span id="job-details-hide"><i class="icon-chevron-up"></i>Hide details</span>
	</a></small>

</hgroup>

<div class="collapse" id="job-details">
	<table class="table table-hover table-condensed">
		<tbody>
			<tr>
				<td><strong>Job:</strong></td>
				<td>
					<strong id="nicename">@uiJob.nicename</strong><br/>
					<small id="id" class="muted">@fwkJob.id</small>
				</td>
			</tr>
			<tr>
				<td>Script:</td>
				<td>
					<span id="scriptname">@uiJob.scriptName</span><br/>
					<small id="scriptid" class="muted">@uiJob.scriptId</small>
				</td>
			</tr>
			<tr>
				<td>Created:</td>
				<td>
					<span id="created-fuzzy" aria-live="timer"></span><br/>
					<small id="created" class="muted">@if(uiJob.created==null){""}else{uiJob.created}</small>
					<script type="text/javascript">
						updateFuzzyCreatedInterval = null;
						updateFuzzyCreated = function(){updateFuzzyCreatedInterval=updateFuzzy("created-fuzzy",new Date(@if(uiJob.created==null){ 999999999999999 }else{ @uiJob.created.getTime() } ));};
						$(updateFuzzyCreated);
						$("#created").html(new Date(@if(uiJob.created==null){ 999999999999999 }else{ @uiJob.created.getTime() })+"");
					</script>
				</td>
			</tr>
			<tr>
				<td>Started:</td>
				<td>
					<span id="started-fuzzy" aria-live="timer"></span><br/>
					<small id="started" class="muted">@if(uiJob.started==null){""}else{uiJob.started}</small>
					<script type="text/javascript">
						updateFuzzyStartedInterval = null;
						updateFuzzyStarted = function(){updateFuzzyStartedInterval=updateFuzzy("started-fuzzy",new Date(@if(uiJob.started==null){ 999999999999999 }else{ @uiJob.started.getTime() } ));};
						$(updateFuzzyStarted);
						$("#started").html(new Date(@if(uiJob.started==null){ 999999999999999 }else{ @uiJob.started.getTime() })+"");
					</script>
				</td>
			</tr>
			<tr>
				<td>Finished:</td>
				<td>
					<span id="finished-fuzzy" aria-live="timer"></span><br/>
					<small id="finished" class="muted">@uiJob.finished</small>
					<script type="text/javascript">
						updateFuzzyFinishedInterval = null;
						updateFuzzyFinished = function(){updateFuzzyFinishedInterval=updateFuzzy("finished-fuzzy",new Date(@if(uiJob.finished==null){ 999999999999999 }else{ @uiJob.finished.getTime() } ));};
						$(updateFuzzyFinished);
						$("#finished").html(new Date(@if(uiJob.finished==null){ 999999999999999 }else{ @uiJob.finished.getTime() })+"");
					</script>
				</td>
			</tr>
			<tr>
				<td>User:</td>
				<td>
					<span id="username">@uiJob.userNicename</span><br/>
					@if(uiJob.user<0){
						<small id="userid" class="muted">#@(-uiJob.user)</small>
					}
				</td>
			</tr>
		</tbody>
	</table>
	<br/>
</div>

<div class="row">
	<div class="hero-unit" style="text-align:center">
	
	<div id="status-done" style="display:none;">
		<h2 role="status" class="text-success">Success</h1>
		<div class="results-buttons" aria-live="polite"></div>
	</div>
	
	<div id="status-validation_fail" style="display:none;">
		<h2 role="status" class="text-error">Validation failed</h1>
		<div class="results-buttons" aria-live="polite"></div>
	</div>
	
	<div id="status-running" style="display:none;">
		<h2 role="status" class="text-info">
			Running
			<span aria-live="none">
				<span id="runningDot1"                       >&nbsp;.&nbsp; &nbsp; &nbsp;</span>
				<span id="runningDot2" style="display: none;">&nbsp;.&nbsp;.&nbsp; &nbsp;</span>
				<span id="runningDot3" style="display: none;">&nbsp;.&nbsp;.&nbsp;.&nbsp;</span>
				<script type="text/javascript">
					window.setInterval(function(){
						if ($("#runningDot1").is(":visible")) {
							$("#runningDot1").hide();
							$("#runningDot2").show();
							
						} else if ($("#runningDot2").is(":visible")) {
							$("#runningDot2").hide();
							$("#runningDot3").show();
							
						} else {
							$("#runningDot3").hide();
							$("#runningDot1").show();
						}
					},1000);
				</script>
			</span>
		</h2>
		<br/>
		<ul style="list-style-type:none;text-align:left;padding-top:20px;"><li id="message-latest">
			@if(fwkJob.messages.size()>0){
				<pre>@fwkJob.messages.get(fwkJob.messages.size()-1).text</pre>
			}else{
				<pre>&nbsp;</pre>
			}
		</li></ul>
	</div>
	
	<div id="status-idle" style="display:none;">
		<h2 role="status" class="text-muted">Queued</h2>
	</div>
	
	<div id="status-error" style="display:none;">
		<h2 role="status" class="text-error">Failed</h2>
		<p>See the message log for details.</p>
	</div>
	
	<script type="text/javascript">
		$("#status-@(fwkJob.status.toString().toLowerCase())").show();
	</script>
	
	</div>
</div>

<div id="result-reports" aria-live="polite"></div>

<div id="results" class="status-done" aria-live="polite">
	<h2>Results</h2>
	
	<p class="results-empty">No results.</p>
	
	<div class="results-nonempty" style="display:none;">
		<p id="results-download-all"></p>
		<ul id="results-list" style="list-style-type:none;" class="results-children"></ul>
	</div>
</div>

<h2>Execution Log</h2>

<br/>
<a class="btn btn-info" href="@routes.Jobs.getLog(fwkJob.id)" target="_blank"><span class="icon-download-alt icon-white"></span> Download Detailed Log</a>
<br/><br/>

<ol aria-live="polite" role="log" class="messagelist" id="message-list">
	@for(message <- fwkJob.messages){
		<li id="m@message.sequence" value="@message.sequence"><span class="message @("text-error".when(org.daisy.pipeline.client.models.job.Message.Level.ERROR==message.level)) @("text-warning".when(org.daisy.pipeline.client.models.job.Message.Level.WARNING==message.level))"">@message.text</span></li>
	}
</ol>

<br/><br/><br/>

<script type="text/javascript">
	$(function(){
		Notifications.listen("job-message-@fwkJob.id", function(message){
			var li = '<li id="m'+message.sequence+'" value="'+message.sequence+'"><span class="message '+(message.level=="ERROR"?"message-error":"")+(message.level=="WARNING"?"message-warn":"")+'">'+message.text+'</span></li>';
			if ($("#m"+message.sequence).size() > 0) {
				$("#m"+message.sequence).replaceWith(li);
			}
			else if (message.sequence < $("#message-list li").last().attr("value")) {
				$("#message-list li")
					.filter(function(i){ return $(this).attr("value") < message.sequence; })
					.last()
					.after(li);
			}
			else {
				$("#message-list").append(li);
				$("#message-latest").html("<pre>"+message.text+"</pre>");
			}
		});
		Notifications.listen("job-status-@fwkJob.id", function(status){
			@for(status <- org.daisy.pipeline.client.models.Job.Status.values()){
				$("#status-@(status.toString().toLowerCase())").hide();
			}
			$("#status-"+status.toLowerCase()).show();
		});
		Notifications.listen("job-started-@fwkJob.id", function(message){
			var date = new Date(parseInt(message.number));
			$("#started").html(date+"");
			clearInterval(updateFuzzyStartedInterval);
			updateFuzzy("started-fuzzy", date);
		});
		Notifications.listen("job-finished-@fwkJob.id", function(message){
			var date = new Date(parseInt(message.number));
			$("#finished").html(date+"");
			clearInterval(updateFuzzyFinishedInterval);
			updateFuzzy("finished-fuzzy", date);
		});
		var updateResultsList = function(result) {
			var li = document.createElement("li");
			if (result.results.length > 0) {
				$(li).append("<a class=\"results-expand-collapse icon-plus\" onclick=\"javascript:$(this).siblings().filter('ul').toggle();$(this).siblings().filter('.results-fileicon').toggleClass('icon-folder-open icon-folder-close');$(this).toggleClass('icon-plus icon-minus');return false;\"></a>");
				$(li).append("<i class=\"results-fileicon icon-folder-close\"></i>");
			} else {
				$(li).append("<span class=\"results-expand-collapse\"></span>");
				$(li).append("<i class=\"results-fileicon icon-file\"></i>");
			}
			
			var fileLink = $("<a class=\"results-filename\"></a>");
			$(fileLink).attr("href", "@routes.Jobs.getResult(fwkJob.id,"")"+result.relativeHref.substring(7));
			$(fileLink).html(result.name!==null&&result.name.length>0?result.name:decodeURIComponent(result.filename.replace(/^idx\//,"")));
			$(li).append(fileLink);
			$(li).append(" ");
			
			$(li).append($("<span class=\"results-filesize\"></span>").html(Job.prettySize(result.size)));
			
			var ul = $("<ul class=\"results-children\" style=\"display:none;list-style-type:none;\"></ul>");
			for (var i = 0; i < result.results.length; i++) {
				$(ul).append(updateResultsList(result.results[i]));
			}
			
			$(li).append(ul);
			return li; 
		}
		var updateResults = function(results){
			var i, j, href;
			if (results.results === null || results.results.length === 0) {
				$("#results .results-empty").show();
				$("#results .results-nonempty").hide();
			} else {
				$("#results .results-empty").hide();
				
				$("#results-list").empty();
				$("#results-download-all").empty();
				$(".results-buttons").empty();
				$("#result-reports").empty();
				
				$("#results-download-all").append($("<a class=\"btn btn-success\" href=\""+"@routes.Jobs.getAllResults(fwkJob.id)"+"\"><span class=\"icon-download-alt icon-white\"></span> Download all results</a>"));
				for (i = 0; i < results.results.length; i++) {
					if (results.results[i].results === null || results.results[i].results.length === 0 || results.results[i].results[0].mimeType.indexOf("application/vnd.pipeline") !== 0) {
						$("#results-list").append(updateResultsList(results.results[i]));
						if (results.results[i].results.length === 1 && results.results[i].results[0].results.length === 0) {
							$(".results-buttons").append("<a class=\"btn btn-large btn-success\" href=\"@routes.Jobs.getResult(fwkJob.id,"")"+results.results[i].results[0].relativeHref.substring(7)+"\"><span class=\"icon-download-alt icon-white\"></span> "+results.results[i].name+"</a> ");
						} else {
							$(".results-buttons").append("<a class=\"btn btn-large btn-success\" href=\"@routes.Jobs.getResult(fwkJob.id,"")"+results.results[i].relativeHref.substring(7)+"\"><span class=\"icon-download-alt icon-white\"></span> "+results.results[i].name+"</a> ");
						}
					}
					
					for (j = 0; j < results.results[i].results.length; j++) {
						if (results.results[i].results[j].mimeType==="application/vnd.pipeline.report+xml") {
							href = "@routes.Jobs.getResult(fwkJob.id,"")"+results.results[i].results[j].relativeHref.substring(7);
							$.ajax({
								url: href+"?parse=report",
								success: function(data, textStatus, jqXHR){
									var section = $("<section class=\"result-report\" data-href=\""+this.href+"\"></section>");
									$(section).html(data);
									$(section).find("*[href^='file:']").replaceWith("<!-- removed filesystem link -->");
									$(section).find("*[href]:not([href^='#'])").each(function(){
										$(this).attr("href",href.replace(/[^/]*$/,"")+$(this).attr("href"));
									});
									$(".result-report[data-href='"+this.href+"'] + hr").remove();
									$(".result-report[data-href='"+this.href+"']").remove();
									$("#result-reports").append($(section));
									$("#result-reports").append("<hr/>");
								},
								context: {href:href}
							});
						}
					}
				}
				
				$("#results .results-nonempty").show();
			}
		};
		Notifications.listen("job-results-@fwkJob.id", updateResults);
		@if(fwkJob.results!=null){
			var results = @Html(play.libs.Json.toJson(fwkJob.results).toString());
			updateResults(results);
		}
		
		if (Math.abs(new Date().getTime() - @(new Date().getTime())) > 1000) {
			// You probably arrived through the back/forward buttons; reload the page contents dynamically
			$.ajax({
				url: "@routes.Jobs.getJobJson(fwkJob.id)?"+new Date().getTime(),
				error: function(jqXHR, textStatus, errorThrown) {
					// error; too bad :(
				},
				success: function(job, textStatus, jqXHR) {
					// updating page contents dynamically...
					clearInterval(updateFuzzyCreatedInterval);
					clearInterval(updateFuzzyStartedInterval);
					clearInterval(updateFuzzyFinishedInterval);
					$("#created").html(new Date(job.created)+"");
					$("#started").html(new Date(job.started)+"");
					$("#finished").html(new Date(job.finished)+"");
					updateFuzzy("created-fuzzy", new Date(job.created));
					updateFuzzy("started-fuzzy", new Date(job.started));
					updateFuzzy("finished-fuzzy", new Date(job.finished));
					
					$("#id").html(job.id);
					$("#header-nicename, #nicename").html(job.nicename);
					$("#scriptid").html(job.scriptId);
					$("#scriptname").html(job.scriptName);
					$("#username").html(job.userNicename);
					$("#userid").html(job.user);
					
					@for(status <- org.daisy.pipeline.client.models.Job.Status.values()){
						$("#status-@(status.toString().toLowerCase())").hide();
					}
					$("#status-"+job.status.toLowerCase()).show();
					
					$("#message-list li").remove();
					for (var m = 0; m < job.messages.length; m++) {
						$("#message-list").append('<li id="m'+job.messages[m].sequence+'" value="'+job.messages[m].sequence+'"><span class="message '+(job.messages[m].level==="ERROR"?"message-error":"")+(job.messages[m].level==="WARNING"?"message-warn":"")+'">'+job.messages[m].text+'</span></li>');
					}
					if (job.messages.length > 0) {
						$("#message-latest").html("<pre>"+job.messages[job.messages.length-1].text+"</pre>");
					}
				}
			});
		}
	});
</script>

}